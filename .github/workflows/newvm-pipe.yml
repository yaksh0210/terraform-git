name: Azure VM via Terraform

on:
  workflow_dispatch:

env:
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

  AZURE_DEVOPS_ORG: yakshrawal
  AZURE_DEVOPS_PROJECT: mlops_practice
  AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}

jobs:

  terraform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

  create-azure-devops-ticket:
    runs-on: ubuntu-latest
    needs: terraform

    # ðŸ”¥ THIS IS THE IMPORTANT FIX
    if: needs.terraform.result == 'failure'

    steps:
      - name: Create Azure DevOps Work Item
        run: |

          echo "Terraform failed. Creating Azure DevOps ticket..."

          cat > /tmp/bug.json << EOF
          [
            {
              "op": "add",
              "path": "/fields/System.Title",
              "value": "Terraform VM Deployment Failed - Run ${{ github.run_id }}"
            },
            {
              "op": "add",
              "path": "/fields/System.Description",
              "value": "Terraform pipeline failed in GitHub Actions.\n\nRepository: ${{ github.repository }}\nRun URL: ${{ github.run_url }}\n\nPlease check the workflow logs for exact error."
            },
            {
              "op": "add",
              "path": "/fields/System.State",
              "value": "New"
            },
            {
              "op": "add",
              "path": "/fields/System.Tags",
              "value": "terraform;azure;ci-cd;failure"
            }
          ]
          EOF

          curl -X POST \
            -u :${{ secrets.AZURE_DEVOPS_PAT }} \
            -H "Content-Type: application/json-patch+json" \
            --data-binary @/tmp/bug.json \
            "https://dev.azure.com/${{ env.AZURE_DEVOPS_ORG }}/${{ env.AZURE_DEVOPS_PROJECT }}/_apis/wit/workitems/\$Issue?api-version=7.0"
